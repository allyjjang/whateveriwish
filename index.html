<!DOCTYPE html>
<html>
<head>
    <title>Korean TTS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            margin: 0;
            margin-bottom: 20px;
        }
        #text {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
            max-height: calc(1.2em * 10);
            overflow-y: auto;
        }
        #input {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #3e8e41;
        }
        #pause {
            background-color: #f44336;
        }
        #pause:hover {
            background-color: #d32f2f;
        }
        .highlight {
            background-color: yellow;
        }
    </style>
</head>
<body>
    <h1>책 읽어주기</h1>
    <div id="text"></div><br><br>
    <label for="file-input"><strong>읽기 파일 추가 (Text 파일만 지원) :</strong></label>
    <input type="file" id="file-input" accept=".txt"><br><br>
    <textarea id="input" rows="5" cols="50"></textarea><br><br>
    <button id="play"><strong>읽기 시작</strong></button>
    <button id="pause"><strong>멈춤</strong></button>
    <button id="resume"><strong>다시 읽기</strong></button><br><br>
    <label for="rate"><strong>읽기 속도 조절 :</strong></label>
    <input type="range" id="rate" name="rate" min="0.5" max="5" step="0.1"><br><br>
    <label for="pitch"><strong>목소리 톤 조절 :</strong></label>
    <input type="range" id="pitch" name="pitch" min="0" max="2" step="0.1"><br><br>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=m5TjGkfq"></script>
    <script>
        let textDiv = document.querySelector('#text');
        let fileInput = document.querySelector('#file-input');
        let inputArea = document.querySelector('#input');
        let playButton = document.querySelector('#play');
        let pauseButton = document.querySelector('#pause');
        let resumeButton = document.querySelector('#resume');
        let rateControl = document.querySelector('#rate');
        let pitchControl = document.querySelector('#pitch');
        let voice;
        let sentences = [];

        function populateVoiceList() {
            voices = speechSynthesis.getVoices();
            voice = voices.find(function(voice) { return voice.lang === 'ko-KR'; });
        }

        populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        rateControl.value = localStorage.getItem('rate') || 1;
        pitchControl.value = localStorage.getItem('pitch') || 1;

        playButton.onclick = function(event) {
            speechSynthesis.cancel();

            textDiv.innerHTML = '';

            sentences = inputArea.value.split('.').filter(sentence => sentence.trim().length > 0);

            for (let i = 0; i < sentences.length; i++) {
                let sentenceSpan = document.createElement('span');
                sentenceSpan.textContent = sentences[i] + '.';
                sentenceSpan.onclick = function(event) {
                    if (speechSynthesis.speaking) {
                        speechSynthesis.cancel();
                        let startSentenceIndex = Array.prototype.indexOf.call(textDiv.children, event.target);
                        let textToSpeak = '';
                        for (let j = startSentenceIndex; j < textDiv.children.length; j += 2) {
                            textToSpeak += textDiv.children[j].textContent + ' ';
                        }
                        responsiveVoice.speak(textToSpeak, 'Korean Female', {
                            rate: rateControl.value,
                            pitch: pitchControl.value
                        });
                    }
                };
                textDiv.appendChild(sentenceSpan);
                textDiv.appendChild(document.createElement('br'));
            }

            responsiveVoice.speak(inputArea.value, 'Korean Female', {
                rate: rateControl.value,
                pitch: pitchControl.value
            });
        };

        pauseButton.onclick = function(event) {
            responsiveVoice.pause();
            for (let i = 0; i < textDiv.children.length; i++) {
                textDiv.children[i].classList.remove('highlight');
            }
        };

        resumeButton.onclick = function(event) {
            responsiveVoice.resume();
        };

        rateControl.oninput = function(event) {
            if (responsiveVoice.isPlaying()) {
                responsiveVoice.cancel();
                responsiveVoice.speak(inputArea.value, 'Korean Female', {
                    rate: rateControl.value,
                    pitch: pitchControl.value
                });
            }
            localStorage.setItem('rate', rateControl.value);
        };

        pitchControl.oninput = function(event) {
            if (responsiveVoice.isPlaying()) {
                responsiveVoice.cancel();
                responsiveVoice.speak(inputArea.value, 'Korean Female', {
                    rate: rateControl.value,
                    pitch: pitchControl.value
                });
            }
            localStorage.setItem('pitch', pitchControl.value);
        };

        fileInput.onchange = function(event) {
            let file = fileInput.files[0];
            let reader = new FileReader();
            reader.onload = function(event) {
                inputArea.value = event.target.result;
            };
            reader.readAsText(file);
        };
    </script>
</body>
</html>
